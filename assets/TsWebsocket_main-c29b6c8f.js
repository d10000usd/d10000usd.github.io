import{C as f,f as k,c as w,a as L}from"./chartOptions-ffd05b59.js";import{w as T,r as l,l as o,g as y,o as v,c as p,a as u,t as b,_ as x,e as d,F as A}from"./index-fea38b97.js";class S{constructor(t,e,i,a,n){this.chartOptions=t,this.candleType=e,this.chartContainer=i,this.chart=null,this.ohlcdata=a,this.guidline=n}async initializeChart(){if(!this.chartContainer.value){console.error("Chart container is not defined.");return}this.clearChartContainer(),this.createChartInstance(),this.addCandlestickSeries(),this.chart.applyOptions(this.chartOptions),this.addTickerTextElement();try{await this.formatedFetchAndUpdateCandle()}catch(t){console.error("Error fetching candle data:",t)}this.watchTickerChanges()}clearChartContainer(){const{children:t}=this.chartContainer.value;t.length>0&&(this.chartContainer.value.innerHTML="")}createChartInstance(){this.chart=f(this.chartContainer.value,{width:this.chartContainer.value.clientWidth,height:380}),window.addEventListener("resize",()=>{this.chart.applyOptions({width:this.chartContainer.value.clientWidth})})}addCandlestickSeries(){this.chart.addCandlestickSeries({priceLineVisible:!1,priceScale:{position:"left"}})}addTickerTextElement(){const t=document.createElement("div"),{ticker:e,candlecnt:i,timeInterval:a}=this.candleType;t.textContent=`Ticker: ${e}  ${i} ${a} `,this.chartContainer.value.appendChild(t)}watchTickerChanges(){T(()=>this.candleType.ticker,async(t,e)=>{e&&e.length>=3&&t!==e&&(this.chart.remove(),this.initializeChart())})}calculateMovingAverage(t,e){const i=[];for(let a=e-1;a<t.length;a++){const s=t.slice(a-(e-1),a+1).reduce((r,c)=>r+c.close,0)/e;i.push({time:t[a].time,value:s})}return i}async formatedFetchAndUpdateCandle(){try{const t=this.chart.addCandlestickSeries({priceLineVisible:!1,priceScale:{position:"left"}}),e=this.ohlcdata;t.setData(e),this.setAddGuidLine(t,e),this.setDataAndMarkersForStLine(t,e),this.updateChartWithAnalysisData(t,e)}catch(t){console.error("Error fetching candle data:",t)}}addPriceLine(t,e){}updateChartWithAnalysisData(t,e){this.addMovingAverages(t,e),this.addPriceLine(t,e),this.addPriceLine_maximum(t,e),this.addPriceLine_minimum(t,e)}addPriceLine_maximum(t,e){let i=this.chartOptions.lineOption.maxPriceLine;i.price=this.guidline.maximum.value,t.createPriceLine(i)}addPriceLine_minimum(t,e){let i=this.chartOptions.lineOption.minPriceLine;i.price=this.guidline.minimum.value,t.createPriceLine(i)}setAddGuidLine(t,e){const i=[{time:this.guidline.maximum.time,value:this.guidline.maximum.value},{time:this.guidline.minimum.time,value:this.guidline.minimum.value},{time:this.guidline.lastClose.time,value:this.guidline.lastClose.value}];i.sort((C,_)=>new Date(C.time).getTime()-new Date(_.time).getTime());const a=i.slice(0,2),n=i.slice(-2),s=a[0].value>a[1].value?"blue":"red",r=n[0].value>n[1].value?"blue":"red",c=this.chart.addLineSeries({color:s,lineWidth:6}),g=this.chart.addLineSeries({color:r,lineWidth:6});c.setData(a),g.setData(n)}setDataAndMarkersForStLine(t,e){t.setData(e);let i=[{time:this.guidline.maximum.time,position:"aboveBar",color:"red",shape:"arrowDown",id:"id4",text:"max @ "+this.guidline.maximum.value,size:4},{time:this.guidline.minimum.time,position:"belowBar",color:"black",shape:"arrowUp",text:"min @  "+this.guidline.minimum.value,size:4},{time:this.guidline.lastClose.time,position:"belowBar",color:"green",shape:"arrowUp",text:"클로즈 @  "+this.guidline.lastClose.value,size:4}];i.sort((a,n)=>a.time-n.time),t.setMarkers(i)}calculateMovingAverage(t,e){const i=[];for(let a=e-1;a<t.length;a++){const s=t.slice(a-(e-1),a+1).reduce((r,c)=>r+c.close,0)/e;i.push({time:t[a].time,value:s})}return i}addSMALine(t,e){this.chart.addLineSeries({color:e.color,lineWidth:e.lineWidth,priceLineVisible:e.priceLineVisible==="true"}).setData(t)}addMovingAverages(t,e){for(const[i,a]of Object.entries(this.chartOptions.movingAverages)){const n=parseInt(i.replace("ma",""),10),s=this.calculateMovingAverage(e,n);this.addSMALine(s,a)}}}const D={class:"container"},m={__name:"TsWebsocket_chart",props:{message:Object,pncounts:Object},setup(h){const e=l(Object.assign([],h.message)),i=o({types:e.value.type,ticker:e.value.ticker,candlecnt:e.value.candlecnt,timeInterval:e.value.timeInterval}),a=l(null),n=l(),s=l();return y(async()=>{n.value=await k(e.value.type,e.value.ticker,e.value.candlecnt,e.value.timeInterval),s.value=await w(n.value),new S(L,i,a,n.value,s.value).initializeChart()}),(r,c)=>(v(),p("div",D,[u("div",{ref_key:"chartContainer0",ref:a},null,512),u("pre",null,b(s.value),1)]))}};const W={__name:"TsWebsocket_main",setup(h){const t=o({types:"candle",ticker:"KRW-SEI",candlecnt:110,timeInterval:"minute60"}),e=o({types:"candle",ticker:"KRW-T",candlecnt:110,timeInterval:"minute60"}),i=o({types:"candle",ticker:"KRW-ETH",candlecnt:110,timeInterval:"minute60"});return(a,n)=>(v(),p(A,null,[d(m,{message:e},null,8,["message"]),d(m,{message:t},null,8,["message"]),d(m,{message:i},null,8,["message"])],64))}},I=x(W,[["__scopeId","data-v-3cb33bde"]]);export{I as default};
